# /web/nginx.conf

# This map is used to set the correct Connection header for WebSocket proxying
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 80;
    server_name localhost;
    # Set a higher max body size for potential file uploads, etc.
    client_max_body_size 10M;

    # Route for all API calls
    location /api {
        # The trailing slash is important!
        proxy_pass http://api:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Main location to serve the Vue.js application
    location / {
        root /usr/share/nginx/html;
        index index.html;
        # This is crucial for single-page applications like Vue
        try_files $uri $uri/ /index.html;
    }

    # When the frontend tries to establish a WebSocket connection on the root path,
    # this separate location block will handle the "Upgrade" request.
    # We use a trick with error_page to avoid using "if" statements.
    # A request with the Upgrade header will be proxied; a regular one will get a 404
    # and fall back to the @websocket location.
    location = / {
        # This block is for WebSocket connections specifically on the root
        error_page 404 @websocket;
        # If the request is not a WebSocket upgrade, it will result in a 404,
        # which will then be handled by the @websocket named location.
        # This is a bit of a workaround to handle both HTTP and WS on the same path.
        if ($http_upgrade = 'websocket') {
             proxy_pass http://api:3001;
             proxy_set_header Upgrade $http_upgrade;
             proxy_set_header Connection $connection_upgrade;
             proxy_set_header Host $host;
             break;
        }
        # For regular HTTP requests to the root, serve the Vue app.
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    # Named location for WebSocket fallback
    location @websocket {
        proxy_pass http://api:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
    }
}
